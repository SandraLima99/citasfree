<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat de Supabase</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1e1e2e;
            color: #cdd6f4;
        }
        
        h1, h2 {
            color: #89b4fa;
        }
        
        .user-list {
            margin-top: 20px;
            border: 1px solid #45475a;
            padding: 10px;
            background-color: #313244;
            border-radius: 5px;
        }
        
        .user-item {
            cursor: pointer;
            padding: 8px;
            margin: 4px 0;
            background-color: #45475a;
            border-radius: 4px;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
        }
        
        .user-item:hover {
            background-color: #585b70;
        }
        
        .user-item.active {
            background-color: #89b4fa;
            color: #1e1e2e;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #585b70;
            margin-right: 10px;
            object-fit: cover;
        }
        
        .message-box {
            border: 1px solid #45475a;
            padding: 10px;
            margin-top: 10px;
            max-height: 400px;
            overflow-y: auto;
            background-color: #313244;
            border-radius: 5px;
        }
        
        .user-info {
            background-color: #313244;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 5px;
            border: 1px solid #45475a;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .user-profile {
            display: flex;
            align-items: center;
        }
        
        .user-profile-pic {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 15px;
            object-fit: cover;
        }
        
        .logout-btn {
            cursor: pointer;
            background-color: #f38ba8;
            color: #1e1e2e;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            font-weight: bold;
        }
        
        input, button, select {
            padding: 8px;
            margin: 5px 0;
            background-color: #45475a;
            color: #cdd6f4;
            border: 1px solid #585b70;
            border-radius: 4px;
        }
        
        button {
            background-color: #89b4fa;
            color: #1e1e2e;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }
        
        button:hover {
            background-color: #74c7ec;
        }
        
        .message-container {
            display: flex;
            margin-bottom: 10px;
        }
        
        .message-sent {
            background-color: #89b4fa;
            color: #1e1e2e;
            padding: 8px 12px;
            border-radius: 8px;
            margin-left: auto;
            max-width: 80%;
        }
        
        .message-received {
            background-color: #45475a;
            padding: 8px 12px;
            border-radius: 8px;
            margin-right: auto;
            max-width: 80%;
        }
        
        .message-time {
            font-size: 0.8em;
            opacity: 0.8;
            margin-top: 4px;
        }
        
        .message-input-container {
            display: flex;
            margin-top: 10px;
            align-items: center;
        }
        
        .message-input {
            flex-grow: 1;
            margin-right: 10px;
        }
        
        #chat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .status-indicator {
            height: 10px;
            width: 10px;
            border-radius: 50%;
            background-color: #a6e3a1;
            margin-right: 5px;
            display: inline-block;
        }
        
        .status-offline {
            background-color: #f38ba8;
        }
        
        .ad-container {
            width: 100%;
            text-align: center;
            margin: 20px 0;
            clear: both;
        }
        
        .chat-image {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            margin-top: 5px;
            cursor: pointer;
        }
        
        .message-sent .chat-image,
        .message-received .chat-image {
            margin-top: 5px;
        }
        
        .profile-upload-container {
            margin-top: 10px;
            display: flex;
            align-items: center;
        }
        
        .image-upload-btn {
            display: flex;
            align-items: center;
            gap: 5px;
            background-color: #585b70;
            color: #cdd6f4;
        }
        
        .image-icon {
            width: 20px;
            height: 20px;
            display: inline-flex;
            justify-content: center;
            align-items: center;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7);
        }
        
        .modal-content {
            margin: 10% auto;
            padding: 20px;
            width: 80%;
            max-width: 500px;
            background-color: #313244;
            border-radius: 8px;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: #cdd6f4;
        }
        
        #imagePreview {
            max-width: 100%;
            max-height: 300px;
            margin: 10px 0;
        }
        
        @media (max-width: 768px) {
            .chat-container .left-panel,
            .chat-container .right-panel {
                width: 100% !important;
                float: none !important;
                margin-right: 0 !important;
                margin-bottom: 20px;
            }
        }
    </style>
</head>
<body>
    <h1>Chat de Supabase</h1>
    
    <!-- Panel de usuario conectado -->
    <div id="user-panel" class="user-info">
        <div class="user-profile">
            <img id="current-user-avatar" src="/api/placeholder/50/50" alt="Avatar" class="user-profile-pic">
            <div>
                <span><span class="status-indicator"></span> Conectado como: <strong id="current-user-name"></strong></span>
                <div class="profile-upload-container">
                    <button onclick="abrirModalFotoPerfil()" class="image-upload-btn">
                        <span class="image-icon">üì∑</span> Cambiar foto de perfil
                    </button>
                </div>
            </div>
        </div>
        <button class="logout-btn" onclick="cerrarSesion()">Cerrar Sesi√≥n</button>
    </div>
    
    <!-- Panel de chat -->
    <div id="chat-panel">
        <div class="chat-container">
            <div class="left-panel" style="width: 30%; float: left; margin-right: 2%;">
                <h2>Usuarios</h2>
                <div id="user-list" class="user-list">
                    <!-- Aqu√≠ se mostrar√°n los usuarios -->
                    <p>Cargando usuarios...</p>
                </div>
            </div>
            
            <div class="right-panel" style="width: 68%; float: left;">
                <div id="chat-header">
                    <h2>Mensajes con: <span id="chat-with">Nadie seleccionado</span></h2>
                </div>
                
                <div id="lista" class="message-box">
                    <p>Selecciona un usuario para comenzar a chatear</p>
                </div>
                
                <div class="message-input-container">
                    <input type="text" id="texto" class="message-input" placeholder="Escribe tu mensaje" disabled>
                    <button id="upload-photo-btn" onclick="abrirModalFoto()" disabled>
                        <span class="image-icon">üì∑</span>
                    </button>
                    <button id="send-button" onclick="enviarMensaje()" disabled>Enviar</button>
                </div>
            </div>
            <div style="clear: both;"></div>
        </div>
    </div>
    
    <!-- Modal para subir foto de perfil -->
    <div id="profilePhotoModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModalFotoPerfil()">&times;</span>
            <h2>Cambiar foto de perfil</h2>
            <input type="file" id="profilePhotoInput" accept="image/*">
            <img id="profilePreview" style="display: none; max-width: 100%; margin: 10px 0;">
            <div style="margin-top: 15px;">
                <button onclick="subirFotoPerfil()">Guardar</button>
                <button onclick="cerrarModalFotoPerfil()" style="background-color: #585b70;">Cancelar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal para subir foto en chat -->
    <div id="photoModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModalFoto()">&times;</span>
            <h2>Enviar una foto</h2>
            <input type="file" id="photoInput" accept="image/*">
            <img id="imagePreview" style="display: none;">
            <div style="margin-top: 15px;">
                <button onclick="enviarFoto()">Enviar</button>
                <button onclick="cerrarModalFoto()" style="background-color: #585b70;">Cancelar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal para ver foto ampliada -->
    <div id="viewPhotoModal" class="modal">
        <div class="modal-content" style="text-align: center;">
            <span class="close" onclick="cerrarModalVerFoto()">&times;</span>
            <img id="enlargedImage" style="max-width: 100%; max-height: 80vh;">
        </div>
    </div>
    
    <!-- Anuncio √∫nico y discreto al final -->
    <div class="ad-container">
        <script type="text/javascript">
            atOptions = { 'key' : '8f88d057e1fda5f2cb45b6efe1cb51c4', 'format' : 'iframe', 'height' : 90, 'width' : 728, 'params' : {} };
        </script>
        <script type="text/javascript" src="//www.highperformanceformat.com/8f88d057e1fda5f2cb45b6efe1cb51c4/invoke.js"></script>
    </div>
    
    <!-- Primero carga la librer√≠a de Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <!-- Luego tu c√≥digo -->
    <script>
        const supabaseUrl = 'https://aosshivxcxlypnsbvghc.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFvc3NoaXZ4Y3hseXBuc2J2Z2hjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ5MzEyODEsImV4cCI6MjA2MDUwNzI4MX0.Vrs5L1Lbw7BwgagXB0Zy5SIrOFe9wBL2fKjBP6vdXtE';
        
        // Usar createClient desde el objeto global importado
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
        
        // Variables para el usuario actual
        let currentUser = null;
        let selectedUser = null;
        let messageCheckInterval = null;
        let userStatusInterval = null;
        let lastMessageTime = new Date().toISOString();
        let selectedPhotoFile = null;
        let selectedProfilePhotoFile = null;
        
        // Cargar sesi√≥n al iniciar la p√°gina
        window.onload = async function() {
            await cargarSesion();
            
            // Prevenir env√≠o de formulario al presionar Enter en el campo de texto
            document.getElementById('texto').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    enviarMensaje();
                }
            });
            
            // Configurar preview de imagen para foto de perfil
            document.getElementById('profilePhotoInput').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    selectedProfilePhotoFile = file;
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const preview = document.getElementById('profilePreview');
                        preview.src = e.target.result;
                        preview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // Configurar preview de imagen para chat
            document.getElementById('photoInput').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    selectedPhotoFile = file;
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const preview = document.getElementById('imagePreview');
                        preview.src = e.target.result;
                        preview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            });
        };
        
        // Funci√≥n para actualizar el estado en l√≠nea del usuario
        async function actualizarEstadoEnLinea() {
            if (!currentUser) return;
            
            try {
                // Actualizar el estado en l√≠nea y la √∫ltima vez activo
                const { error } = await supabaseClient
                    .from('usuarios')
                    .update({ 
                        online: true,
                        last_active: new Date().toISOString()
                    })
                    .eq('id', currentUser.id);
                
                if (error) {
                    console.error('Error actualizando estado online:', error);
                }
            } catch (err) {
                console.error('Error en actualizarEstadoEnLinea:', err);
            }
        }
        
        // Verificar y actualizar estados de usuario
        async function verificarEstadosUsuarios() {
            try {
                // Obtener todos los usuarios
                const { data, error } = await supabaseClient
                    .from('usuarios')
                    .select('*');
                
                if (error) {
                    console.error('Error obteniendo estados:', error);
                    return;
                }
                
                // Marcar usuarios como offline si no han estado activos en los √∫ltimos 2 minutos
                const ahora = new Date();
                const dosMinutosAtras = new Date(ahora - 2 * 60 * 1000).toISOString();
                
                const usuariosInactivos = data.filter(user => 
                    user.online && user.last_active && user.last_active < dosMinutosAtras
                );
                
                if (usuariosInactivos.length > 0) {
                    // Actualizar usuarios inactivos a offline
                    for (const user of usuariosInactivos) {
                        await supabaseClient
                            .from('usuarios')
                            .update({ online: false })
                            .eq('id', user.id);
                    }
                    
                    // Actualizar la interfaz
                    cargarUsuarios();
                }
            } catch (err) {
                console.error('Error en verificarEstadosUsuarios:', err);
            }
        }
        
        // Funci√≥n para cargar la sesi√≥n del usuario desde localStorage
        async function cargarSesion() {
            const userId = localStorage.getItem('userId');
            const userAlias = localStorage.getItem('userAlias');
            const userAvatar = localStorage.getItem('userAvatar');
            
            if (!userId || !userAlias) {
                // Redirigir a la p√°gina de login si no hay sesi√≥n
                window.location.href = 'index.html';
                return;
            }
            
            // Verificar que el usuario sigue existiendo en la base de datos
            const { data, error } = await supabaseClient
                .from('usuarios')
                .select('*')
                .eq('id', userId)
                .single();
            
            if (data && !error) {
                // Establecer sesi√≥n
                currentUser = data;
                document.getElementById('current-user-name').textContent = currentUser.alias;
                
                // Actualizar avatar si existe
                if (userAvatar) {
                    document.getElementById('current-user-avatar').src = userAvatar;
                } else if (data.avatar) {
                    document.getElementById('current-user-avatar').src = data.avatar;
                    // Guardar en localStorage para futuras sesiones
                    localStorage.setItem('userAvatar', data.avatar);
                }
                
                // Actualizar estado en l√≠nea
                actualizarEstadoEnLinea();
                
                // Cargar usuarios y mensajes
                await cargarUsuarios();
                listarMensajes();
                
                // Iniciar verificaci√≥n autom√°tica de mensajes nuevos
                iniciarActualizacionAutomatica();
                
                // Iniciar verificaci√≥n autom√°tica de estado en l√≠nea
                iniciarVerificacionEstado();
                
                // Configurar evento de cierre de ventana para marcar offline
                window.addEventListener('beforeunload', marcarOffline);
            } else {
                // Si el usuario no existe, limpiar localStorage y redirigir al login
                cerrarSesion();
            }
        }
        
        // Marcar usuario como offline al cerrar la ventana
        async function marcarOffline() {
            if (currentUser) {
                try {
                    await supabaseClient
                        .from('usuarios')
                        .update({ online: false })
                        .eq('id', currentUser.id);
                } catch (err) {
                    console.error('Error al marcar offline:', err);
                }
            }
        }
        
        // Iniciar actualizaci√≥n autom√°tica de mensajes
        function iniciarActualizacionAutomatica() {
            // Detener cualquier intervalo existente
            if (messageCheckInterval) {
                clearInterval(messageCheckInterval);
            }
            
            // Comprobar mensajes nuevos cada 5 segundos
            messageCheckInterval = setInterval(function() {
                verificarMensajesNuevos();
            }, 5000);
        }
        
        // Iniciar verificaci√≥n de estado en l√≠nea
        function iniciarVerificacionEstado() {
            // Detener cualquier intervalo existente
            if (userStatusInterval) {
                clearInterval(userStatusInterval);
            }
            
            // Actualizar estado cada 30 segundos
            userStatusInterval = setInterval(function() {
                actualizarEstadoEnLinea();
                verificarEstadosUsuarios();
            }, 30000);
        }
        
        // Verificar mensajes nuevos
        async function verificarMensajesNuevos() {
            if (!currentUser) return;
            
            // Buscar mensajes m√°s recientes que el √∫ltimo verificado
            const { data, error } = await supabaseClient
                .from('mensajes')
                .select('*')
                .eq('destinatario_id', currentUser.id)
                .gt('enviado_en', lastMessageTime)
                .order('enviado_en', { ascending: false });
            
            if (error) {
                console.error('Error verificando mensajes nuevos:', error);
                return;
            }
            
            // Si hay mensajes nuevos, actualizar la vista
            if (data && data.length > 0) {
                // Actualizar el tiempo del √∫ltimo mensaje
                lastMessageTime = new Date().toISOString();
                
                // Actualizar mensajes si hay un usuario seleccionado
                if (selectedUser) {
                    listarMensajesConUsuario(selectedUser.id);
                } else {
                    listarMensajes();
                }
                
                // Tambi√©n actualizar la lista de usuarios para reflejar cambios
                cargarUsuarios();
            }
        }
        
        // Cerrar sesi√≥n
        async function cerrarSesion() {
            if (currentUser) {
                // Marcar como offline antes de cerrar sesi√≥n
                await supabaseClient
                    .from('usuarios')
                    .update({ online: false })
                    .eq('id', currentUser.id);
            }
            
            localStorage.removeItem('userId');
            localStorage.removeItem('userAlias');
            localStorage.removeItem('userAvatar');
            
            // Detener la actualizaci√≥n autom√°tica
            if (messageCheckInterval) {
                clearInterval(messageCheckInterval);
                messageCheckInterval = null;
            }
            
            if (userStatusInterval) {
                clearInterval(userStatusInterval);
                userStatusInterval = null;
            }
            
            // Eliminar evento de beforeunload
            window.removeEventListener('beforeunload', marcarOffline);
            
            // Redirigir a la p√°gina de login
            window.location.href = 'index.html';
        }
        
        // Cargar lista de usuarios
        async function cargarUsuarios() {
            const { data, error } = await supabaseClient
                .from('usuarios')
                .select('*')
                .order('alias');
                
            if (error) {
                console.error('Error cargando usuarios:', error);
                return;
            }
            
            const userListDiv = document.getElementById('user-list');
            
            // Limpiar lista
            userListDiv.innerHTML = '';
            
            if (data.length === 0) {
                userListDiv.innerHTML = '<p>No hay usuarios registrados</p>';
                return;
            }
            
            if (data.length === 1 && data[0].id === currentUser.id) {
                userListDiv.innerHTML = '<p>No hay otros usuarios para chatear</p>';
                return;
            }
            
            data.forEach(user => {
                // No mostrar al usuario actual en la lista
                if (currentUser && user.id === currentUser.id) return;
                
                // A√±adir a la lista visual
                const userDiv = document.createElement('div');
                userDiv.className = 'user-item';
                userDiv.dataset.userId = user.id;
                userDiv.dataset.userAlias = user.alias;
                
                // Indicador de estado en l√≠nea
                const statusIndicator = document.createElement('span');
                statusIndicator.className = user.online ? 'status-indicator' : 'status-indicator status-offline';
                userDiv.appendChild(statusIndicator);
                
                // A√±adir avatar del usuario
                const avatarImg = document.createElement('img');
                avatarImg.className = 'user-avatar';
                avatarImg.src = user.avatar || '/api/placeholder/40/40';
                avatarImg.alt = user.alias;
                userDiv.appendChild(avatarImg);
                
                // A√±adir nombre del usuario
                const nameSpan = document.createElement('span');
                nameSpan.textContent = user.alias;
                userDiv.appendChild(nameSpan);
                
                // A√±adir evento de clic para seleccionar usuario
                userDiv.onclick = function() {
                    // Eliminar selecci√≥n anterior
                    document.querySelectorAll('.user-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    
                    // A√±adir selecci√≥n a este usuario
                    userDiv.classList.add('active');
                    
                    // Establecer usuario seleccionado
                    selectedUser = {
                        id: user.id,
                        alias: user.alias
                    };
                    
                    // Actualizar encabezado del chat
                    document.getElementById('chat-with').textContent = user.alias;
                    
                    // Habilitar entrada de texto y bot√≥n de enviar
                    document.getElementById('texto').disabled = false;
                    document.getElementById('send-button').disabled = false;
                    document.getElementById('upload-photo-btn').disabled = false;
                    
                    // Cargar mensajes con este usuario
                    listarMensajesConUsuario(user.id);
                };
                
                userListDiv.appendChild(userDiv);
            });
        }
        
        // Funciones para manejar el modal de foto de perfil
        function abrirModalFotoPerfil() {
            document.getElementById('profilePhotoModal').style.display = 'block';
            document.getElementById('profilePhotoInput').value = '';
            document.getElementById('profilePreview').style.display = 'none';
            selectedProfilePhotoFile = null;
        }
        
        function cerrarModalFotoPerfil() {
            document.getElementById('profilePhotoModal').style.display = 'none';
        }
        
        // Funciones para manejar el modal de foto de chat
        function abrirModalFoto() {
            document.getElementById('photoModal').style.display = 'block';
            document.getElementById('photoInput').value = '';
            document.getElementById('imagePreview').style.display = 'none';
            selectedPhotoFile = null;
        }
        
        function cerrarModalFoto() {
            document.getElementById('photoModal').style.display = 'none';
        }
        
        // Funciones para manejar el modal de ver foto
        function abrirModalVerFoto(imgSrc) {
            document.getElementById('viewPhotoModal').style.display = 'block';
            document.getElementById('enlargedImage').src = imgSrc;
        }
        
        function cerrarModalVerFoto() {
            document.getElementById('viewPhotoModal').style.display = 'none';
        }
        
        // Subir foto de perfil
        async function subirFotoPerfil() {
            if (!currentUser || !selectedProfilePhotoFile) {
                alert('Debes seleccionar una imagen');
                return;
            }
            
            try {
                // Mostrar mensaje de carga
                alert('Subiendo foto de perfil...');
                
                // Generar nombre √∫nico para el archivo
                const fileExt = selectedProfilePhotoFile.name.split('.').pop();
                const fileName = `profile_${currentUser.id}_${Date.now()}.${fileExt}`;
                const filePath = `avatars/${fileName}`;
                
                // Subir archivo a Supabase Storage
                const { error: uploadError } = await supabaseClient
                    .storage
                    .from('media')
                    .upload(filePath, selectedProfilePhotoFile);
                
                if (uploadError) {
                    alert('Error al subir la imagen: ' + uploadError.message);
                    console.error(uploadError);
                    return;
                }
                
                // Obtener URL p√∫blica del archivo
                const { data: urlData } = await supabaseClient
                    .storage
                    .from('media')
                    .getPublicUrl(filePath);
                
                if (!urlData || !urlData.publicUrl) {
                    alert('Error al obtener la URL de la imagen');
                    return;
                }
                
                // Actualizar el avatar del usuario en la base de datos
                const { error: updateError } = await supabaseClient
                    .from('usuarios')
                    .update({ avatar: urlData.publicUrl })
                    .eq('id', currentUser.id);
                
                if (updateError) {
                    alert('Error al actualizar el avatar: ' + updateError.message);
                    console.error(updateError);
                    return;
                }
                
                // Actualizar interfaz y cerrar modal
                document.getElementById('current-user-avatar').src = urlData.publicUrl;
                
                // Guardar en localStorage
                localStorage.setItem('userAvatar', urlData.publicUrl);
                
                // Actualizar objeto de usuario actual
                currentUser.avatar = urlData.publicUrl;
                
                cerrarModalFotoPerfil();
                
                alert('¬°Foto de perfil actualizada con √©xito!');
            } catch (error) {
                console.error('Error subiendo foto de perfil:', error);
                alert('Ocurri√≥ un error al subir la foto de perfil');
            }
        }
        
        // Enviar foto en chat
        async function enviarFoto() {
            if (!currentUser || !selectedUser || !selectedPhotoFile) {
                alert('Debes seleccionar una imagen');
                return;
            }
            
            try {
                // Mostrar mensaje de carga
                alert('Enviando foto...');
                
                // Generar nombre √∫nico para el archivo
                const fileExt = selectedPhotoFile.name.split('.').pop();
                // Continuaci√≥n del c√≥digo para enviar foto en chat
                const fileName = `chat_${currentUser.id}_${Date.now()}.${fileExt}`;
                const filePath = `chatimages/${fileName}`;
                
                // Subir archivo a Supabase Storage
                const { error: uploadError } = await supabaseClient
                    .storage
                    .from('media')
                    .upload(filePath, selectedPhotoFile);
                
                if (uploadError) {
                    alert('Error al subir la imagen: ' + uploadError.message);
                    console.error(uploadError);
                    return;
                }
                
                // Obtener URL p√∫blica del archivo
                const { data: urlData } = await supabaseClient
                    .storage
                    .from('media')
                    .getPublicUrl(filePath);
                
                if (!urlData || !urlData.publicUrl) {
                    alert('Error al obtener la URL de la imagen');
                    return;
                }
                
                // Crear mensaje con imagen
                const { error: msgError } = await supabaseClient
                    .from('mensajes')
                    .insert([
                        {
                            emisor_id: currentUser.id,
                            destinatario_id: selectedUser.id,
                            texto: '',
                            imagen_url: urlData.publicUrl
                        }
                    ]);
                
                if (msgError) {
                    alert('Error al enviar la imagen: ' + msgError.message);
                    console.error(msgError);
                    return;
                }
                
                // Actualizar la vista de mensajes
                listarMensajesConUsuario(selectedUser.id);
                
                // Cerrar modal y limpiar
                cerrarModalFoto();
                
                // Mostrar mensaje de √©xito
                alert('¬°Foto enviada con √©xito!');
            } catch (error) {
                console.error('Error enviando foto:', error);
                alert('Ocurri√≥ un error al enviar la foto');
            }
        }
        
        // Funci√≥n para listar mensajes (pantalla inicial)
        async function listarMensajes() {
            if (!currentUser) return;
            
            // Mostrar mensaje por defecto
            const listaDiv = document.getElementById('lista');
            listaDiv.innerHTML = '<p>Selecciona un usuario para comenzar a chatear</p>';
        }
        
        // Funci√≥n para listar mensajes con un usuario espec√≠fico
        async function listarMensajesConUsuario(userId) {
            if (!currentUser) return;
            
            // Consulta para obtener mensajes en ambas direcciones
            const { data, error } = await supabaseClient
                .from('mensajes')
                .select('*')
                .or(`emisor_id.eq.${currentUser.id},destinatario_id.eq.${currentUser.id}`)
                .or(`emisor_id.eq.${userId},destinatario_id.eq.${userId}`)
                .order('enviado_en', { ascending: true });
            
            const listaDiv = document.getElementById('lista');
            
            // Limpiar lista
            listaDiv.innerHTML = '';
            
            if (error) {
                console.error('Error cargando mensajes:', error);
                listaDiv.innerHTML = '<p>Error al cargar mensajes</p>';
                return;
            }
            
            if (!data || data.length === 0) {
                listaDiv.innerHTML = '<p>No hay mensajes a√∫n. ¬°Env√≠a el primero!</p>';
                return;
            }
            
            // Filtrar solo mensajes entre estos dos usuarios
            const mensajesFiltrados = data.filter(mensaje => 
                (mensaje.emisor_id === currentUser.id && mensaje.destinatario_id === userId) ||
                (mensaje.emisor_id === userId && mensaje.destinatario_id === currentUser.id)
            );
            
            if (mensajesFiltrados.length === 0) {
                listaDiv.innerHTML = '<p>No hay mensajes a√∫n. ¬°Env√≠a el primero!</p>';
                return;
            }
            
            // Mostrar mensajes
            mensajesFiltrados.forEach(mensaje => {
                const messageContainer = document.createElement('div');
                messageContainer.className = 'message-container';
                
                const messageDiv = document.createElement('div');
                
                // Determinar si el mensaje es enviado o recibido
                if (mensaje.emisor_id === currentUser.id) {
                    messageDiv.className = 'message-sent';
                } else {
                    messageDiv.className = 'message-received';
                }
                
                // A√±adir texto si hay
                if (mensaje.texto && mensaje.texto.trim() !== '') {
                    const textPara = document.createElement('p');
                    textPara.textContent = mensaje.texto;
                    messageDiv.appendChild(textPara);
                }
                
                // A√±adir imagen si hay
                if (mensaje.imagen_url) {
                    const img = document.createElement('img');
                    img.src = mensaje.imagen_url;
                    img.className = 'chat-image';
                    img.alt = 'Imagen compartida';
                    img.onclick = function() {
                        abrirModalVerFoto(mensaje.imagen_url);
                    };
                    messageDiv.appendChild(img);
                }
                
                // A√±adir hora del mensaje
                const timeSpan = document.createElement('div');
                timeSpan.className = 'message-time';
                
                // Formatear fecha
                const fecha = new Date(mensaje.enviado_en);
                timeSpan.textContent = `${fecha.getHours().toString().padStart(2, '0')}:${fecha.getMinutes().toString().padStart(2, '0')}`;
                
                messageDiv.appendChild(timeSpan);
                messageContainer.appendChild(messageDiv);
                listaDiv.appendChild(messageContainer);
            });
            
            // Hacer scroll hasta el √∫ltimo mensaje
            listaDiv.scrollTop = listaDiv.scrollHeight;
            
            // Actualizar √∫ltimo tiempo verificado
            lastMessageTime = new Date().toISOString();
        }
        
        // Enviar mensaje de texto
        async function enviarMensaje() {
            if (!currentUser || !selectedUser) return;
            
            const textoInput = document.getElementById('texto');
            const mensaje = textoInput.value.trim();
            
            if (!mensaje) {
                alert('Escribe un mensaje');
                return;
            }
            
            try {
                const { error } = await supabaseClient
                    .from('mensajes')
                    .insert([
                        {
                            emisor_id: currentUser.id,
                            destinatario_id: selectedUser.id,
                            texto: mensaje
                        }
                    ]);
                
                if (error) {
                    console.error('Error enviando mensaje:', error);
                    alert('Error al enviar el mensaje');
                    return;
                }
                
                // Limpiar campo de texto
                textoInput.value = '';
                
                // Actualizar vista de mensajes
                listarMensajesConUsuario(selectedUser.id);
            } catch (err) {
                console.error('Error en enviarMensaje:', err);
                alert('Ocurri√≥ un error al enviar el mensaje');
            }
        }
    </script>
</body>
</html>
