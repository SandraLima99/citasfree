<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - Supabase</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1e1e2e;
            color: #cdd6f4;
        }
        
        h1, h2, h3 {
            color: #89b4fa;
            text-align: center;
        }
        
        input, button {
            padding: 8px;
            margin: 5px 0;
            background-color: #45475a;
            color: #cdd6f4;
            border: 1px solid #585b70;
            border-radius: 4px;
        }
        
        button {
            background-color: #89b4fa;
            color: #1e1e2e;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }
        
        button:hover {
            background-color: #74c7ec;
        }
        
        .chat-container {
            background-color: #313244;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #45475a;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
            object-fit: cover;
        }
        
        .user-alias {
            font-weight: bold;
        }
        
        .logout-button {
            margin-left: auto;
            background-color: #f38ba8;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        #message-list {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 10px;
            padding: 10px;
            background-color: #1e1e2e;
            border-radius: 4px;
        }
        
        .message {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 4px;
        }
        
        .my-message {
            background-color: #89b4fa;
            color: #1e1e2e;
            margin-left: 20%;
        }
        
        .other-message {
            background-color: #45475a;
            margin-right: 20%;
        }
        
        .message-header {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .message-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-right: 8px;
            object-fit: cover;
        }
        
        .message-alias {
            font-weight: bold;
        }
        
        .message-content {
            word-break: break-word;
        }
        
        #message-form {
            display: flex;
            gap: 10px;
        }
        
        #message-input {
            flex-grow: 1;
        }
        
        .ad-container {
            width: 100%;
            text-align: center;
            margin: 20px 0;
            clear: both;
        }
    </style>
</head>
<body>
    <h1>Chat de Supabase</h1>
    
    <div class="chat-container">
        <div class="user-info">
            <img id="user-avatar" src="/api/placeholder/40/40" alt="Avatar" class="user-avatar">
            <span id="user-alias" class="user-alias">Usuario</span>
            <button class="logout-button" onclick="cerrarSesion()">Cerrar sesión</button>
        </div>
        
        <div id="message-list">
            <!-- Los mensajes se cargarán aquí -->
        </div>
        
        <div id="message-form">
            <input type="text" id="message-input" placeholder="Escribe tu mensaje...">
            <button id="send-button" onclick="enviarMensaje()">Enviar</button>
        </div>
    </div>
    
    <!-- Anuncio único y discreto al final -->
    <div class="ad-container">
        <script type="text/javascript">
            atOptions = { 'key' : '8f88d057e1fda5f2cb45b6efe1cb51c4', 'format' : 'iframe', 'height' : 90, 'width' : 728, 'params' : {} };
        </script>
        <script type="text/javascript" src="//www.highperformanceformat.com/8f88d057e1fda5f2cb45b6efe1cb51c4/invoke.js"></script>
    </div>
    
    <!-- Primero carga la librería de Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <!-- Luego tu código -->
    <script>
        const supabaseUrl = 'https://aosshivxcxlypnsbvghc.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFvc3NoaXZ4Y3hseXBuc2J2Z2hjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ5MzEyODEsImV4cCI6MjA2MDUwNzI4MX0.Vrs5L1Lbw7BwgagXB0Zy5SIrOFe9wBL2fKjBP6vdXtE';
        
        // Usar createClient desde el objeto global importado
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
        
        // Verificar si hay sesión al cargar la página
        window.onload = async function() {
            const userId = localStorage.getItem('userId');
            const userAlias = localStorage.getItem('userAlias');
            const userAvatar = localStorage.getItem('userAvatar');
            
            if (!userId) {
                // Si no hay usuario, redirigir al login
                window.location.href = 'login.html';
                return;
            }
            
            // Actualizar la interfaz con la información del usuario
            document.getElementById('user-alias').textContent = userAlias || 'Usuario';
            if (userAvatar) {
                document.getElementById('user-avatar').src = userAvatar;
            }
            
            // Cargar mensajes y establecer suscripción
            cargarMensajes();
            establecerSuscripcion();
            
            // Configurar evento para enviar mensaje con Enter
            document.getElementById('message-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    enviarMensaje();
                }
            });
        };
        
        // Cargar mensajes existentes
        async function cargarMensajes() {
            try {
                const { data, error } = await supabaseClient
                    .from('mensajes')
                    .select('*')
                    .order('created_at', { ascending: true });
                
                if (error) throw error;
                
                // Limpiar contenedor de mensajes
                const messageList = document.getElementById('message-list');
                messageList.innerHTML = '';
                
                // Añadir mensajes a la interfaz
                data.forEach(mensaje => {
                    agregarMensajeUI(mensaje);
                });
                
                // Scroll al último mensaje
                messageList.scrollTop = messageList.scrollHeight;
            } catch (error) {
                console.error('Error al cargar mensajes:', error);
            }
        }
        
        // Establecer suscripción a nuevos mensajes
        function establecerSuscripcion() {
            supabaseClient
                .channel('mensajes_publicos')
                .on('postgres_changes', { 
                    event: 'INSERT', 
                    schema: 'public', 
                    table: 'mensajes' 
                }, payload => {
                    // Añadir nuevo mensaje a la interfaz
                    agregarMensajeUI(payload.new);
                    
                    // Scroll al último mensaje
                    const messageList = document.getElementById('message-list');
                    messageList.scrollTop = messageList.scrollHeight;
                })
                .subscribe();
        }
        
        // Añadir mensaje a la interfaz
        function agregarMensajeUI(mensaje) {
            const messageList = document.getElementById('message-list');
            const userId = localStorage.getItem('userId');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = mensaje.user_id === userId ? 'message my-message' : 'message other-message';
            
            const headerDiv = document.createElement('div');
            headerDiv.className = 'message-header';
            
            const avatar = document.createElement('img');
            avatar.className = 'message-avatar';
            avatar.src = mensaje.user_avatar || '/api/placeholder/30/30';
            avatar.alt = 'Avatar';
            
            const alias = document.createElement('span');
            alias.className = 'message-alias';
            alias.textContent = mensaje.user_alias || 'Usuario';
            
            const content = document.createElement('div');
            content.className = 'message-content';
            content.textContent = mensaje.contenido;
            
            headerDiv.appendChild(avatar);
            headerDiv.appendChild(alias);
            messageDiv.appendChild(headerDiv);
            messageDiv.appendChild(content);
            
            messageList.appendChild(messageDiv);
        }
        
        // Enviar mensaje
        async function enviarMensaje() {
            const messageInput = document.getElementById('message-input');
            const contenido = messageInput.value.trim();
            
            if (!contenido) return; // No enviar mensajes vacíos
            
            const userId = localStorage.getItem('userId');
            const userAlias = localStorage.getItem('userAlias');
            const userAvatar = localStorage.getItem('userAvatar');
            
            if (!userId) {
                window.location.href = 'login.html';
                return;
            }
            
            try {
                const { error } = await supabaseClient
                    .from('mensajes')
                    .insert([
                        { 
                            contenido, 
                            user_id: userId,
                            user_alias: userAlias,
                            user_avatar: userAvatar
                        }
                    ]);
                
                if (error) throw error;
                
                // Limpiar campo de entrada
                messageInput.value = '';
            } catch (error) {
                console.error('Error al enviar mensaje:', error);
                alert('Error al enviar mensaje. Por favor, intenta de nuevo.');
            }
        }
        
        // Cerrar sesión
        function cerrarSesion() {
            // Eliminar datos de sesión
            localStorage.removeItem('userId');
            localStorage.removeItem('userAlias');
            localStorage.removeItem('userAvatar');
            
            // Redirigir al login
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>
