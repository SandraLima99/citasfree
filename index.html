<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Chat de Supabase</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1e1e2e;
            color: #cdd6f4;
        }
        
        h1, h2, h3 {
            color: #89b4fa;
            text-align: center;
        }
        
        input, button, select {
            padding: 8px;
            margin: 5px 0;
            background-color: #45475a;
            color: #cdd6f4;
            border: 1px solid #585b70;
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
        }
        
        button {
            background-color: #89b4fa;
            color: #1e1e2e;
            border: none;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
        }
        
        button:hover {
            background-color: #74c7ec;
        }
        
        .hidden {
            display: none;
        }
        
        .auth-container {
            background-color: #313244;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #45475a;
            margin-top: 20px;
        }
        
        .profile-picture-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .profile-picture-preview {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: #45475a;
            margin-bottom: 10px;
            object-fit: cover;
        }
        
        .file-input-container {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
            text-align: center;
        }
        
        .file-input-container input[type=file] {
            font-size: 100px;
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
        }
        
        .file-input-label {
            display: inline-block;
            padding: 8px 15px;
            background-color: #89b4fa;
            color: #1e1e2e;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            width: 80%;
        }
        
        .button-group {
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }
        
        .button-group button {
            flex: 1;
        }
        
        .error-message {
            color: #f38ba8;
            margin-top: 5px;
            font-size: 14px;
        }
        
        .required-field {
            color: #f38ba8;
            font-size: 14px;
            margin-top: 5px;
        }
        
        .ad-container {
            width: 100%;
            text-align: center;
            margin: 20px 0;
            clear: both;
        }
        
        #chat-container {
            display: none;
            background-color: #313244;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #45475a;
            margin-top: 20px;
        }
        
        #message-list {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 10px;
            padding: 10px;
            background-color: #1e1e2e;
            border-radius: 4px;
        }
        
        .message {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 4px;
        }
        
        .my-message {
            background-color: #89b4fa;
            color: #1e1e2e;
            margin-left: 20%;
        }
        
        .other-message {
            background-color: #45475a;
            margin-right: 20%;
        }
        
        .message-header {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .message-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-right: 8px;
            object-fit: cover;
        }
        
        .message-alias {
            font-weight: bold;
        }
        
        .message-content {
            word-break: break-word;
        }
        
        #message-form {
            display: flex;
            gap: 10px;
        }
        
        #message-input {
            flex-grow: 1;
        }
        
        #send-button {
            width: auto;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
            object-fit: cover;
        }
        
        .user-alias {
            font-weight: bold;
        }
        
        .logout-button {
            margin-left: auto;
            background-color: #f38ba8;
            color: #1e1e2e;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>Chat de Supabase</h1>
    
    <!-- Panel de autenticación -->
    <div id="auth-section" class="auth-container">
        <div id="login-panel">
            <h2>Iniciar sesión</h2>
            <input type="text" id="login-alias" placeholder="Ingresa tu alias">
            <div id="login-error" class="error-message"></div>
            <div class="button-group">
                <button onclick="iniciarSesion()">Iniciar Sesión</button>
                <button onclick="mostrarRegistro()">Registrarse</button>
            </div>
        </div>
        
        <!-- Formulario de registro con foto de perfil -->
        <div id="registro-panel" class="hidden">
            <h2>Crear cuenta</h2>
            
            <div class="profile-picture-container">
                <img id="preview-avatar" src="/api/placeholder/100/100" alt="Avatar Preview" class="profile-picture-preview">
                <div class="file-input-container">
                    <label for="avatar-upload" class="file-input-label">Seleccionar Foto</label>
                    <input type="file" id="avatar-upload" accept="image/*" onchange="previewImage(event)">
                </div>
                <div class="required-field">* La foto de perfil es obligatoria</div>
            </div>
            
            <input type="text" id="registro-alias" placeholder="Ingresa tu alias">
            <div id="registro-error" class="error-message"></div>
            <div class="button-group">
                <button onclick="registrarUsuario()">Crear Cuenta</button>
                <button onclick="volverLogin()">Volver</button>
            </div>
        </div>
    </div>
    
    <!-- Chat integrado para evitar redirecciones 404 -->
    <div id="chat-container">
        <div class="user-info">
            <img id="user-avatar" src="/api/placeholder/40/40" alt="Avatar" class="user-avatar">
            <span id="user-alias" class="user-alias"></span>
            <button class="logout-button" onclick="cerrarSesion()">Cerrar sesión</button>
        </div>
        
        <div id="message-list"></div>
        
        <div id="message-form">
            <input type="text" id="message-input" placeholder="Escribe tu mensaje...">
            <button id="send-button" onclick="enviarMensaje()">Enviar</button>
        </div>
    </div>
    
    <!-- Anuncio único y discreto al final -->
    <div class="ad-container">
        <script type="text/javascript">
            atOptions = { 'key' : '8f88d057e1fda5f2cb45b6efe1cb51c4', 'format' : 'iframe', 'height' : 90, 'width' : 728, 'params' : {} };
        </script>
        <script type="text/javascript" src="//www.highperformanceformat.com/8f88d057e1fda5f2cb45b6efe1cb51c4/invoke.js"></script>
    </div>
    
    <!-- Primero carga la librería de Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <!-- Luego tu código -->
    <script>
        const supabaseUrl = 'https://aosshivxcxlypnsbvghc.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFvc3NoaXZ4Y3hseXBuc2J2Z2hjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ5MzEyODEsImV4cCI6MjA2MDUwNzI4MX0.Vrs5L1Lbw7BwgagXB0Zy5SIrOFe9wBL2fKjBP6vdXtE';
        
        // Usar createClient desde el objeto global importado
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
        
        // Variable para almacenar la imagen en base64
        let imageBase64 = null;
        
        // Verificar si ya hay sesión al cargar la página
        window.onload = async function() {
            const userId = localStorage.getItem('userId');
            const userAlias = localStorage.getItem('userAlias');
            
            if (userId && userAlias) {
                // Verificar que el usuario sigue existiendo en la base de datos
                const { data, error } = await supabaseClient
                    .from('usuarios')
                    .select('*')
                    .eq('id', userId)
                    .single();
                
                if (data && !error) {
                    // Si hay sesión activa, mostrar el chat
                    mostrarChat();
                }
            }
        };
        
        // Mostrar panel de registro
        function mostrarRegistro() {
            document.getElementById('login-panel').classList.add('hidden');
            document.getElementById('registro-panel').classList.remove('hidden');
            document.getElementById('registro-alias').value = document.getElementById('login-alias').value;
            document.getElementById('registro-error').textContent = '';
        }
        
        // Volver al panel de login
        function volverLogin() {
            document.getElementById('login-panel').classList.remove('hidden');
            document.getElementById('registro-panel').classList.add('hidden');
            document.getElementById('login-error').textContent = '';
        }
        
        // Previsualizar imagen seleccionada
        function previewImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('preview-avatar').src = e.target.result;
                    imageBase64 = e.target.result; // Guardar la imagen en formato base64
                };
                reader.readAsDataURL(file);
            }
        }
        
        // Iniciar sesión con alias existente
        async function iniciarSesion() {
            const alias = document.getElementById('login-alias').value.trim();
            const errorElement = document.getElementById('login-error');
            
            if (!alias) {
                errorElement.textContent = 'Por favor ingresa un alias';
                return;
            }
            
            // Buscar usuario por alias
            const { data, error } = await supabaseClient
                .from('usuarios')
                .select('*')
                .eq('alias', alias)
                .maybeSingle();
            
            if (error) {
                errorElement.textContent = 'Error al buscar usuario: ' + error.message;
                return;
            }
            
            if (!data) {
                errorElement.textContent = 'Usuario no encontrado. ¿Quieres registrarte?';
                mostrarRegistro();
                return;
            }
            
            // Guardar sesión
            localStorage.setItem('userId', data.id);
            localStorage.setItem('userAlias', data.alias);
            
            // Si tiene avatar, guardarlo también
            if (data.avatar) {
                localStorage.setItem('userAvatar', data.avatar);
            }
            
            // Mostrar el chat en vez de redirigir
            mostrarChat();
        }
        
        // Registrar nuevo usuario
        async function registrarUsuario() {
            const alias = document.getElementById('registro-alias').value.trim();
            const errorElement = document.getElementById('registro-error');
            
            // Validar datos de registro
            if (!alias) {
                errorElement.textContent = 'Por favor ingresa un alias';
                return;
            }
            
            // Validar que se haya subido una foto (OBLIGATORIO)
            if (!imageBase64) {
                errorElement.textContent = 'La foto de perfil es obligatoria';
                return;
            }
            
            // Verificar si el alias ya existe
            const { data: existingUser } = await supabaseClient
                .from('usuarios')
                .select('*')
                .eq('alias', alias)
                .maybeSingle();
            
            if (existingUser) {
                errorElement.textContent = 'Este alias ya está en uso. Por favor elige otro o inicia sesión.';
                return;
            }
            
            try {
                // Registrar nuevo usuario con avatar
                const { data, error } = await supabaseClient
                    .from('usuarios')
                    .insert([{ 
                        alias: alias,
                        avatar: imageBase64 // Guardar la imagen en base64
                    }])
                    .select();
                
                if (error) {
                    errorElement.textContent = 'Error al registrar: ' + error.message;
                    console.error(error);
                    return;
                }
                
                if (data && data.length > 0) {
                    // Guardar sesión
                    localStorage.setItem('userId', data[0].id);
                    localStorage.setItem('userAlias', data[0].alias);
                    localStorage.setItem('userAvatar', imageBase64);
                    
                    // Mostrar el chat en vez de redirigir
                    mostrarChat();
                }
            } catch (error) {
                errorElement.textContent = 'Error inesperado: ' + error.message;
                console.error(error);
            }
        }
        
        // Mostrar interfaz de chat después de autenticación
        function mostrarChat() {
            // Ocultar sección de autenticación
            document.getElementById('auth-section').style.display = 'none';
            
            // Mostrar contenedor de chat
            const chatContainer = document.getElementById('chat-container');
            chatContainer.style.display = 'block';
            
            // Cargar información del usuario
            const userAlias = localStorage.getItem('userAlias');
            const userAvatar = localStorage.getItem('userAvatar');
            
            document.getElementById('user-alias').textContent = userAlias;
            
            if (userAvatar) {
                document.getElementById('user-avatar').src = userAvatar;
            }
            
            // Cargar mensajes anteriores
            cargarMensajes();
            
            // Configurar suscripción a nuevos mensajes
            suscribirseAMensajes();
        }
        
        // Cargar mensajes anteriores
        async function cargarMensajes() {
            const { data, error } = await supabaseClient
                .from('mensajes')
                .select(`
                    *,
                    usuarios:usuario_id (alias, avatar)
                `)
                .order('created_at', { ascending: true })
                .limit(50);
            
            if (error) {
                console.error('Error al cargar mensajes:', error);
                return;
            }
            
            const messageList = document.getElementById('message-list');
            messageList.innerHTML = '';
            
            if (data && data.length > 0) {
                data.forEach(mensaje => {
                    agregarMensajeALista(mensaje);
                });
                
                // Scroll al final
                messageList.scrollTop = messageList.scrollHeight;
            }
        }
        
        // Suscribirse a nuevos mensajes en tiempo real
        function suscribirseAMensajes() {
            supabaseClient
                .channel('mensajes-publicos')
                .on('postgres_changes', { 
                    event: 'INSERT', 
                    schema: 'public', 
                    table: 'mensajes' 
                }, payload => {
                    // Obtener detalles del usuario que envió el mensaje
                    obtenerDetallesUsuario(payload.new.usuario_id).then(usuario => {
                        const mensajeCompleto = {
                            ...payload.new,
                            usuarios: usuario
                        };
                        agregarMensajeALista(mensajeCompleto);
                        
                        // Scroll al final
                        const messageList = document.getElementById('message-list');
                        messageList.scrollTop = messageList.scrollHeight;
                    });
                })
                .subscribe();
        }
        
        // Obtener detalles del usuario para mostrar en mensajes
        async function obtenerDetallesUsuario(userId) {
            const { data, error } = await supabaseClient
                .from('usuarios')
                .select('alias, avatar')
                .eq('id', userId)
                .single();
                
            if (error || !data) {
                console.error('Error al obtener detalles del usuario:', error);
                return { alias: 'Desconocido', avatar: null };
            }
            
            return data;
        }
        
        // Agregar mensaje a la lista de mensajes
        function agregarMensajeALista(mensaje) {
            const messageList = document.getElementById('message-list');
            const userId = localStorage.getItem('userId');
            
            const esPropio = mensaje.usuario_id == userId;
            
            const mensajeElement = document.createElement('div');
            mensajeElement.className = `message ${esPropio ? 'my-message' : 'other-message'}`;
            
            // Si no es un mensaje propio, mostrar avatar y alias
            if (!esPropio) {
                const headerElement = document.createElement('div');
                headerElement.className = 'message-header';
                
                const avatarElement = document.createElement('img');
                avatarElement.className = 'message-avatar';
                avatarElement.src = mensaje.usuarios?.avatar || '/api/placeholder/30/30';
                avatarElement.alt = 'Avatar';
                
                const aliasElement = document.createElement('div');
                aliasElement.className = 'message-alias';
                aliasElement.textContent = mensaje.usuarios?.alias || 'Desconocido';
                
                headerElement.appendChild(avatarElement);
                headerElement.appendChild(aliasElement);
                mensajeElement.appendChild(headerElement);
            }
            
            const contentElement = document.createElement('div');
            contentElement.className = 'message-content';
            contentElement.textContent = mensaje.contenido;
            
            mensajeElement.appendChild(contentElement);
            messageList.appendChild(mensajeElement);
        }
        
        // Enviar un nuevo mensaje
        async function enviarMensaje() {
            const messageInput = document.getElementById('message-input');
            const contenido = messageInput.value.trim();
            
            if (!contenido) return;
            
            const userId = localStorage.getItem('userId');
            
            // Insertar mensaje en la base de datos
            const { error } = await supabaseClient
                .from('mensajes')
                .insert([{
                    usuario_id: userId,
                    contenido: contenido
                }]);
                
            if (error) {
                console.error('Error al enviar mensaje:', error);
                return;
            }
            
            // Limpiar campo de entrada
            messageInput.value = '';
        }
        
        // Cerrar sesión
        function cerrarSesion() {
            // Limpiar datos de sesión
            localStorage.removeItem('userId');
            localStorage.removeItem('userAlias');
            localStorage.removeItem('userAvatar');
            
            // Recargar la página para volver al login
            window.location.reload();
        }
        
        // Permitir enviar mensaje con Enter
        document.addEventListener('DOMContentLoaded', function() {
            const messageInput = document.getElementById('message-input');
            if (messageInput) {
                messageInput.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        enviarMensaje();
                    }
                });
            }
        });
    </script>
</body>
</html>
