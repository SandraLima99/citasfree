<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Chat de Supabase</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1e1e2e;
            color: #cdd6f4;
        }
        
        h1, h2, h3 {
            color: #89b4fa;
            text-align: center;
        }
        
        input, button, select {
            padding: 8px;
            margin: 5px 0;
            background-color: #45475a;
            color: #cdd6f4;
            border: 1px solid #585b70;
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
        }
        
        button {
            background-color: #89b4fa;
            color: #1e1e2e;
            border: none;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
        }
        
        button:hover {
            background-color: #74c7ec;
        }
        
        .hidden {
            display: none;
        }
        
        .auth-container {
            background-color: #313244;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #45475a;
            margin-top: 20px;
        }
        
        .profile-picture-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .profile-picture-preview {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: #45475a;
            margin-bottom: 10px;
            object-fit: cover;
        }
        
        .file-input-container {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
            text-align: center;
        }
        
        .file-input-container input[type=file] {
            font-size: 100px;
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
        }
        
        .file-input-label {
            display: inline-block;
            padding: 8px 15px;
            background-color: #89b4fa;
            color: #1e1e2e;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            width: 80%;
        }
        
        .button-group {
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }
        
        .button-group button {
            flex: 1;
        }
        
        .ad-container {
            width: 100%;
            text-align: center;
            margin: 20px 0;
            clear: both;
        }
    </style>
</head>
<body>
    <h1>Chat de Supabase</h1>
    
    <!-- Panel de autenticación -->
    <div class="auth-container">
        <div id="login-panel">
            <h2>Iniciar sesión</h2>
            <input type="text" id="login-alias" placeholder="Ingresa tu alias">
            <div class="button-group">
                <button onclick="iniciarSesion()">Iniciar Sesión</button>
                <button onclick="mostrarRegistro()">Registrarse</button>
            </div>
        </div>
        
        <!-- Formulario de registro con foto de perfil -->
        <div id="registro-panel" class="hidden">
            <h2>Crear cuenta</h2>
            
            <div class="profile-picture-container">
                <img id="preview-avatar" src="/api/placeholder/100/100" alt="Avatar Preview" class="profile-picture-preview">
                <div class="file-input-container">
                    <label for="avatar-upload" class="file-input-label">Seleccionar Foto</label>
                    <input type="file" id="avatar-upload" accept="image/*" onchange="previewImage(event)">
                </div>
            </div>
            
            <input type="text" id="registro-alias" placeholder="Ingresa tu alias">
            <div class="button-group">
                <button onclick="registrarUsuario()">Crear Cuenta</button>
                <button onclick="volverLogin()">Volver</button>
            </div>
        </div>
    </div>
    
    <!-- Anuncio único y discreto al final -->
    <div class="ad-container">
        <script type="text/javascript">
            atOptions = { 'key' : '8f88d057e1fda5f2cb45b6efe1cb51c4', 'format' : 'iframe', 'height' : 90, 'width' : 728, 'params' : {} };
        </script>
        <script type="text/javascript" src="//www.highperformanceformat.com/8f88d057e1fda5f2cb45b6efe1cb51c4/invoke.js"></script>
    </div>
    
    <!-- Primero carga la librería de Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <!-- Luego tu código -->
    <script>
        const supabaseUrl = 'https://aosshivxcxlypnsbvghc.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFvc3NoaXZ4Y3hseXBuc2J2Z2hjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ5MzEyODEsImV4cCI6MjA2MDUwNzI4MX0.Vrs5L1Lbw7BwgagXB0Zy5SIrOFe9wBL2fKjBP6vdXtE';
        
        // Usar createClient desde el objeto global importado
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
        
        // Variable para almacenar la imagen en base64
        let imageBase64 = null;
        
        // Verificar si ya hay sesión al cargar la página
        window.onload = async function() {
            const userId = localStorage.getItem('userId');
            const userAlias = localStorage.getItem('userAlias');
            
            if (userId && userAlias) {
                // Verificar que el usuario sigue existiendo en la base de datos
                const { data, error } = await supabaseClient
                    .from('usuarios')
                    .select('*')
                    .eq('id', userId)
                    .single();
                
                if (data && !error) {
                    // Si hay sesión, redirigir al chat
                    window.location.href = 'chat.html';
                }
            }
        };
        
        // Mostrar panel de registro
        function mostrarRegistro() {
            document.getElementById('login-panel').classList.add('hidden');
            document.getElementById('registro-panel').classList.remove('hidden');
            document.getElementById('registro-alias').value = document.getElementById('login-alias').value;
        }
        
        // Volver al panel de login
        function volverLogin() {
            document.getElementById('login-panel').classList.remove('hidden');
            document.getElementById('registro-panel').classList.add('hidden');
        }
        
        // Previsualizar imagen seleccionada
        function previewImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('preview-avatar').src = e.target.result;
                    imageBase64 = e.target.result; // Guardar la imagen en formato base64
                };
                reader.readAsDataURL(file);
            }
        }
        
        // Iniciar sesión con alias existente
        async function iniciarSesion() {
            const alias = document.getElementById('login-alias').value;
            if (!alias) {
                alert('Por favor ingresa un alias');
                return;
            }
            
            // Buscar usuario por alias
            const { data, error } = await supabaseClient
                .from('usuarios')
                .select('*')
                .eq('alias', alias)
                .maybeSingle();
            
            if (error) {
                alert('Error buscando usuario: ' + error.message);
                return;
            }
            
            if (!data) {
                alert('Usuario no encontrado. ¿Quieres registrarte?');
                mostrarRegistro();
                return;
            }
            
            // Guardar sesión
            localStorage.setItem('userId', data.id);
            localStorage.setItem('userAlias', data.alias);
            
            // Si tiene avatar, guardarlo también
            if (data.avatar) {
                localStorage.setItem('userAvatar', data.avatar);
            }
            
            alert('¡Sesión iniciada correctamente!');
            
            // Redirigir a la página de chat
            window.location.href = 'chat.html';
        }
        
        // Registrar nuevo usuario
        async function registrarUsuario() {
            const alias = document.getElementById('registro-alias').value;
            if (!alias) {
                alert('Por favor ingresa un alias');
                return;
            }
            
            // Verificar si el alias ya existe
            const { data: existingUser } = await supabaseClient
                .from('usuarios')
                .select('*')
                .eq('alias', alias)
                .maybeSingle();
            
            if (existingUser) {
                alert('Este alias ya está en uso. Por favor elige otro o inicia sesión.');
                return;
            }
            
            // Registrar nuevo usuario con avatar si se subió uno
            const { data, error } = await supabaseClient
                .from('usuarios')
                .insert([{ 
                    alias: alias,
                    avatar: imageBase64 // Guardar la imagen en base64
                }])
                .select();
            
            if (error) {
                alert('Error: ' + error.message);
                console.error(error);
                return;
            }
            
            if (data && data.length > 0) {
                // Guardar sesión
                localStorage.setItem('userId', data[0].id);
                localStorage.setItem('userAlias', data[0].alias);
                
                // Guardar avatar si existe
                if (imageBase64) {
                    localStorage.setItem('userAvatar', imageBase64);
                }
                
                alert('¡Usuario registrado con éxito!');
                
                // Redirigir a la página de chat
                window.location.href = 'usuarios.html';
            }
        }
    </script>
</body>
</html>
