<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CitasFree Básico</title>
</head>
<body>
    <h1>CitasFree</h1>
    <button id="logout-btn">Cerrar sesión</button>
    
    <div id="usuarios-lista">
        <h2>Cargando usuarios...</h2>
    </div>
    
    <div id="chat-container" style="display: none;">
        <div>
            <h3 id="chat-title">Chat</h3>
            <button id="close-chat">Cerrar</button>
        </div>
        <div id="chat-messages">
            <!-- Los mensajes se cargarán aquí -->
        </div>
        <div>
            <input type="text" id="message-input" placeholder="Escribe un mensaje...">
            <button id="send-message">Enviar</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.4/dist/umd/supabase.min.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Configuración de Supabase
            const supabaseUrl = 'https://aosshivxcxlypnsbvghc.supabase.co';
            const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFvc3NoaXZ4Y3hseXBuc2J2Z2hjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ5MzEyODEsImV4cCI6MjA2MDUwNzI4MX0.Vrs5L1Lbw7BwgagXB0Zy5SIrOFe9wBL2fKjBP6vdXtE';
            const supabase = supabaseCreateClient(supabaseUrl, supabaseKey);
            
            // Variables para el chat
            let currentChatUser = null;
            let chatInterval = null;
            
            // Verificar si el usuario está autenticado
            const usuarioJSON = sessionStorage.getItem('usuario');
            if (!usuarioJSON) {
                window.location.href = 'index.html';
                return;
            }
            
            const usuario = JSON.parse(usuarioJSON);
            console.log('Usuario actual:', usuario);
            
            // Función para cargar usuarios
            async function cargarUsuarios() {
                try {
                    const { data, error } = await supabase
                        .from('usuarios')
                        .select('*');
                    
                    if (error) {
                        console.error('Error al cargar usuarios:', error);
                        document.getElementById('usuarios-lista').innerHTML = 
                            '<p>Error al cargar usuarios. Intente nuevamente más tarde.</p>';
                        return;
                    }
                    
                    console.log('Usuarios cargados:', data);
                    const listaElement = document.getElementById('usuarios-lista');
                    
                    if (data && data.length > 0) {
                        let html = '<h2>Usuarios</h2><ul>';
                        
                        data.forEach(user => {
                            // Saltamos si es el usuario actual
                            if (user.id === usuario.id) return;
                            
                            html += `<li data-user-id="${user.id}" data-user-name="${user.alias}">${user.alias}</li>`;
                        });
                        
                        html += `<li>${usuario.alias} (Tú)</li>`;
                        html += '</ul>';
                        
                        listaElement.innerHTML = html;
                        
                        // Añadir event listeners a los elementos de la lista
                        document.querySelectorAll('#usuarios-lista li[data-user-id]').forEach(li => {
                            li.addEventListener('click', () => {
                                const userId = li.getAttribute('data-user-id');
                                const userName = li.getAttribute('data-user-name');
                                abrirChat({id: userId, alias: userName});
                            });
                        });
                    } else {
                        listaElement.innerHTML = '<p>No hay usuarios registrados</p>';
                    }
                } catch (err) {
                    console.error('Error inesperado:', err);
                    document.getElementById('usuarios-lista').innerHTML = 
                        '<p>Error al conectar con el servidor.</p>';
                }
            }
            
            // Función para marcar al usuario como en línea
            async function actualizarEstadoUsuario() {
                try {
                    const { error } = await supabase
                        .from('usuarios')
                        .update({ 
                            en_linea: true,
                            ultima_conexion: new Date().toISOString()
                        })
                        .eq('id', usuario.id);
                        
                    if (error) {
                        console.error('Error al actualizar estado:', error);
                    } else {
                        console.log('Estado actualizado correctamente');
                    }
                } catch (err) {
                    console.error('Error al actualizar estado:', err);
                }
            }
            
            // Función para abrir el chat con un usuario
            function abrirChat(user) {
                console.log('Abriendo chat con:', user);
                const chatContainer = document.getElementById('chat-container');
                const chatTitle = document.getElementById('chat-title');
                const chatMessages = document.getElementById('chat-messages');
                
                // Guardar usuario actual del chat
                currentChatUser = user;
                
                // Configurar título del chat
                chatTitle.textContent = `Chat con ${user.alias}`;
                
                // Vaciar mensajes anteriores
                chatMessages.innerHTML = '';
                
                // Mostrar el contenedor del chat
                chatContainer.style.display = 'block';
                
                // Cargar mensajes existentes
                cargarMensajes();
                
                // Iniciar intervalo para recargar mensajes
                if (chatInterval) clearInterval(chatInterval);
                chatInterval = setInterval(cargarMensajes, 3000);
            }
            
            // Función para cargar mensajes
            async function cargarMensajes() {
                if (!currentChatUser) return;
                
                try {
                    console.log('Cargando mensajes entre', usuario.id, 'y', currentChatUser.id);
                    
                    // Consulta para obtener mensajes enviados y recibidos entre los dos usuarios
                    const { data, error } = await supabase
                        .from('mensajes')
                        .select('*')
                        .order('created_at', { ascending: true });
                    
                    if (error) {
                        console.error('Error al cargar mensajes:', error);
                        return;
                    }
                    
                    console.log('Mensajes sin filtrar:', data);
                    
                    // Filtrar manualmente los mensajes entre estos dos usuarios específicos
                    const mensajesFiltrados = data.filter(msg => 
                        (msg.remitente_id === usuario.id && msg.destinatario_id === currentChatUser.id) ||
                        (msg.remitente_id === currentChatUser.id && msg.destinatario_id === usuario.id)
                    );
                    
                    console.log('Mensajes filtrados:', mensajesFiltrados);
                    
                    const chatMessages = document.getElementById('chat-messages');
                    chatMessages.innerHTML = '';
                    
                    mensajesFiltrados.forEach(mensaje => {
                        const esEnviado = mensaje.remitente_id === usuario.id;
                        chatMessages.innerHTML += `<div>${esEnviado ? 'Tú: ' : currentChatUser.alias + ': '}${mensaje.contenido}</div>`;
                    });
                    
                } catch (err) {
                    console.error('Error inesperado al cargar mensajes:', err);
                }
            }
            
            // Función para enviar mensaje
            async function enviarMensaje() {
                if (!currentChatUser) return;
                
                const messageInput = document.getElementById('message-input');
                const mensaje = messageInput.value.trim();
                
                if (!mensaje) return;
                
                try {
                    console.log('Enviando mensaje:', {
                        remitente_id: usuario.id,
                        destinatario_id: currentChatUser.id,
                        contenido: mensaje
                    });
                    
                    const { data, error } = await supabase
                        .from('mensajes')
                        .insert([{
                            remitente_id: usuario.id,
                            destinatario_id: currentChatUser.id,
                            contenido: mensaje,
                            created_at: new Date().toISOString()
                        }]);
                    
                    if (error) {
                        console.error('Error al enviar mensaje:', error);
                        return;
                    }
                    
                    console.log('Mensaje enviado con éxito:', data);
                    
                    // Limpiar input
                    messageInput.value = '';
                    
                    // Recargar mensajes para mostrar el mensaje enviado
                    cargarMensajes();
                } catch (err) {
                    console.error('Error al enviar mensaje:', err);
                }
            }
            
            // Event listeners
            document.getElementById('logout-btn').addEventListener('click', function() {
                sessionStorage.removeItem('usuario');
                window.location.href = 'index.html';
            });
            
            document.getElementById('close-chat').addEventListener('click', function() {
                document.getElementById('chat-container').style.display = 'none';
                currentChatUser = null;
                if (chatInterval) clearInterval(chatInterval);
            });
            
            document.getElementById('send-message').addEventListener('click', enviarMensaje);
            
            document.getElementById('message-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    enviarMensaje();
                }
            });
            
            // Marcar usuario como en línea
            actualizarEstadoUsuario();
            
            // Cargar usuarios inicialmente
            cargarUsuarios();
            
            // Recargar usuarios periódicamente
            setInterval(cargarUsuarios, 30000);
            
            // Limpiar intervalo de chat al cerrar la página
            window.addEventListener('beforeunload', function() {
                if (chatInterval) clearInterval(chatInterval);
            });
            
            // Función para crear el cliente de Supabase (corrección)
            function supabaseCreateClient(url, key) {
                return supabase.createClient(url, key);
            }
        });
    </script>
</body>
</html>
