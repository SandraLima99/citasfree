<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CitasFree Básico</title>
    <style>
        /* Estilos mínimos para mejor legibilidad */
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        #usuarios-lista ul {
            padding-left: 20px;
        }
        #usuarios-lista li {
            margin: 10px 0;
            cursor: pointer;
        }
        #usuarios-lista li:hover {
            text-decoration: underline;
        }
        #chat-container {
            border: 1px solid #ccc;
            padding: 10px;
            margin-top: 20px;
        }
        #chat-messages {
            height: 200px;
            overflow-y: auto;
            border: 1px solid #eee;
            padding: 10px;
            margin: 10px 0;
        }
        #message-input {
            width: 70%;
            padding: 5px;
        }
        .message-sent {
            color: blue;
            margin: 5px 0;
        }
        .message-received {
            color: green;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <h1>CitasFree</h1>
    <button id="logout-btn">Cerrar sesión</button>
    
    <div id="info-usuario"></div>
    
    <div id="usuarios-lista">
        <h2>Cargando usuarios...</h2>
    </div>
    
    <div id="chat-container" style="display: none;">
        <div>
            <h3 id="chat-title">Chat</h3>
            <button id="close-chat">Cerrar</button>
        </div>
        <div id="chat-messages"></div>
        <div>
            <input type="text" id="message-input" placeholder="Escribe un mensaje...">
            <button id="send-message">Enviar</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.4/dist/umd/supabase.min.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Configuración de Supabase
            const supabaseUrl = 'https://aosshivxcxlypnsbvghc.supabase.co';
            const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFvc3NoaXZ4Y3hseXBuc2J2Z2hjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ5MzEyODEsImV4cCI6MjA2MDUwNzI4MX0.Vrs5L1Lbw7BwgagXB0Zy5SIrOFe9wBL2fKjBP6vdXtE';
            const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
            
            // Variables para el chat
            let currentChatUser = null;
            let chatInterval = null;
            
            // Verificar si el usuario está autenticado
            const usuarioJSON = sessionStorage.getItem('usuario');
            if (!usuarioJSON) {
                window.location.href = 'index.html';
                return;
            }
            
            const usuario = JSON.parse(usuarioJSON);
            console.log('Usuario actual:', usuario);
            
            // Mostrar información del usuario actual
            document.getElementById('info-usuario').innerHTML = `<p>Conectado como: <strong>${usuario.alias}</strong> (ID: ${usuario.id})</p>`;
            
            // Función para cargar usuarios
            async function cargarUsuarios() {
                try {
                    const { data, error } = await supabase
                        .from('usuarios')
                        .select('id, alias, en_linea, ultima_conexion');
                    
                    if (error) {
                        console.error('Error al cargar usuarios:', error);
                        document.getElementById('usuarios-lista').innerHTML = 
                            '<p>Error al cargar usuarios: ' + error.message + '</p>';
                        return;
                    }
                    
                    console.log('Usuarios cargados:', data);
                    const listaElement = document.getElementById('usuarios-lista');
                    
                    if (data && data.length > 0) {
                        let html = '<h2>Usuarios disponibles</h2><ul>';
                        
                        data.forEach(user => {
                            // No mostrar el usuario actual en la lista
                            if (user.id === usuario.id) return;
                            
                            const ultimaConexion = new Date(user.ultima_conexion);
                            const ahora = new Date();
                            const diferenciaMinutos = Math.floor((ahora - ultimaConexion) / (1000 * 60));
                            const estadoTexto = diferenciaMinutos < 5 ? "Activo recientemente" : `Última vez hace ${diferenciaMinutos} minutos`;
                            
                            html += `<li onclick="window.abrirChatUsuario(${user.id}, '${user.alias}')">
                                        ${user.alias} - ${estadoTexto}
                                    </li>`;
                        });
                        
                        html += '</ul>';
                        listaElement.innerHTML = html;
                    } else {
                        listaElement.innerHTML = '<p>No hay usuarios registrados</p>';
                    }
                } catch (err) {
                    console.error('Error inesperado:', err);
                    document.getElementById('usuarios-lista').innerHTML = 
                        '<p>Error al conectar con el servidor: ' + err.message + '</p>';
                }
            }
            
            // Función para marcar al usuario como en línea
            async function actualizarEstadoUsuario() {
                try {
                    const ahora = new Date().toISOString();
                    const { error } = await supabase
                        .from('usuarios')
                        .update({ 
                            en_linea: true,
                            ultima_conexion: ahora,
                            ultima_actividad: ahora
                        })
                        .eq('id', usuario.id);
                        
                    if (error) {
                        console.error('Error al actualizar estado:', error);
                    } else {
                        console.log('Estado actualizado correctamente');
                    }
                } catch (err) {
                    console.error('Error al actualizar estado:', err);
                }
            }
            
            // Exponer la función para abrir chat en window para poder llamarla desde HTML
            window.abrirChatUsuario = function(userId, userAlias) {
                abrirChat({ id: userId, alias: userAlias });
            };
            
            // Función para abrir el chat con un usuario
            function abrirChat(user) {
                console.log('Abriendo chat con:', user);
                const chatContainer = document.getElementById('chat-container');
                const chatTitle = document.getElementById('chat-title');
                const chatMessages = document.getElementById('chat-messages');
                
                // Guardar usuario actual del chat
                currentChatUser = user;
                
                // Configurar título del chat
                chatTitle.textContent = `Chat con ${user.alias}`;
                
                // Vaciar mensajes anteriores
                chatMessages.innerHTML = '';
                
                // Mostrar el contenedor del chat
                chatContainer.style.display = 'block';
                
                // Cargar mensajes existentes
                cargarMensajes();
                
                // Iniciar intervalo para recargar mensajes
                if (chatInterval) clearInterval(chatInterval);
                chatInterval = setInterval(cargarMensajes, 3000);
            }
            
            // Función para cargar mensajes
            async function cargarMensajes() {
                if (!currentChatUser) return;
                
                try {
                    console.log('Cargando mensajes entre', usuario.id, 'y', currentChatUser.id);
                    
                    // Realizar una consulta más específica
                    const { data, error } = await supabase
                        .from('mensajes')
                        .select('*')
                        .or(`and(remitente_id.eq.${usuario.id},destinatario_id.eq.${currentChatUser.id}),and(remitente_id.eq.${currentChatUser.id},destinatario_id.eq.${usuario.id})`)
                        .order('created_at', { ascending: true });
                    
                    if (error) {
                        console.error('Error al cargar mensajes:', error);
                        document.getElementById('chat-messages').innerHTML = 
                            '<p>Error al cargar mensajes: ' + error.message + '</p>';
                        return;
                    }
                    
                    console.log('Mensajes cargados:', data);
                    
                    const chatMessages = document.getElementById('chat-messages');
                    chatMessages.innerHTML = '';
                    
                    if (data && data.length > 0) {
                        data.forEach(mensaje => {
                            const esEnviado = mensaje.remitente_id === usuario.id;
                            const messageDiv = document.createElement('div');
                            messageDiv.className = esEnviado ? 'message-sent' : 'message-received';
                            messageDiv.textContent = `${esEnviado ? 'Tú: ' : currentChatUser.alias + ': '}${mensaje.contenido}`;
                            chatMessages.appendChild(messageDiv);
                        });
                    } else {
                        chatMessages.innerHTML = '<p>No hay mensajes. ¡Inicia la conversación!</p>';
                    }
                    
                    // Scroll al final
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                } catch (err) {
                    console.error('Error inesperado al cargar mensajes:', err);
                    document.getElementById('chat-messages').innerHTML = 
                        '<p>Error al cargar mensajes: ' + err.message + '</p>';
                }
            }
            
            // Función para enviar mensaje
            async function enviarMensaje() {
                if (!currentChatUser) return;
                
                const messageInput = document.getElementById('message-input');
                const mensaje = messageInput.value.trim();
                
                if (!mensaje) return;
                
                try {
                    const ahora = new Date().toISOString();
                    console.log('Enviando mensaje:', {
                        remitente_id: usuario.id,
                        destinatario_id: currentChatUser.id,
                        contenido: mensaje,
                        created_at: ahora
                    });
                    
                    const { data, error } = await supabase
                        .from('mensajes')
                        .insert([{
                            remitente_id: usuario.id,
                            destinatario_id: currentChatUser.id,
                            contenido: mensaje,
                            created_at: ahora
                        }]);
                    
                    if (error) {
                        console.error('Error al enviar mensaje:', error);
                        alert('Error al enviar mensaje: ' + error.message);
                        return;
                    }
                    
                    console.log('Mensaje enviado con éxito');
                    
                    // Limpiar input
                    messageInput.value = '';
                    
                    // Añadir inmediatamente el mensaje al chat para mejor UX
                    const chatMessages = document.getElementById('chat-messages');
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'message-sent';
                    messageDiv.textContent = `Tú: ${mensaje}`;
                    chatMessages.appendChild(messageDiv);
                    
                    // Scroll al final
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                    
                    // Actualizar última actividad del usuario
                    actualizarEstadoUsuario();
                } catch (err) {
                    console.error('Error al enviar mensaje:', err);
                    alert('Error al enviar mensaje: ' + err.message);
                }
            }
            
            // Event listeners
            document.getElementById('logout-btn').addEventListener('click', function() {
                // Marcar usuario como desconectado antes de salir
                supabase
                    .from('usuarios')
                    .update({ en_linea: false })
                    .eq('id', usuario.id)
                    .then(() => {
                        sessionStorage.removeItem('usuario');
                        window.location.href = 'index.html';
                    });
            });
            
            document.getElementById('close-chat').addEventListener('click', function() {
                document.getElementById('chat-container').style.display = 'none';
                currentChatUser = null;
                if (chatInterval) clearInterval(chatInterval);
            });
            
            document.getElementById('send-message').addEventListener('click', enviarMensaje);
            
            document.getElementById('message-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    enviarMensaje();
                }
            });
            
            // Marcar usuario como en línea
            actualizarEstadoUsuario();
            
            // Cargar usuarios inicialmente
            cargarUsuarios();
            
            // Recargar usuarios cada 15 segundos
            setInterval(cargarUsuarios, 15000);
            
            // Al cerrar la página, marcar usuario como desconectado
            window.addEventListener('beforeunload', function() {
                if (chatInterval) clearInterval(chatInterval);
                
                // Usando navigator.sendBeacon para enviar una solicitud final incluso si la página se está cerrando
                const formData = new FormData();
                formData.append('id', usuario.id);
                navigator.sendBeacon('/api/desconectar', formData);
                
                // También intentamos la actualización directa (aunque puede no completarse)
                supabase
                    .from('usuarios')
                    .update({ en_linea: false })
                    .eq('id', usuario.id);
            });
        });
    </script>
</body>
</html>
